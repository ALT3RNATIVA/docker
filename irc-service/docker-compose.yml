version: '3'

services:
  ircd:
    # inspircd
    image: inspircd/inspircd-docker:testing
    restart: always

    build : 
       context: inspircd-docker/.
       args:
         # - VERSION=
         - "CONFIGUREARGS=--enable-extras geo_maxmind" 
                         #--enable-extras m_regex_pcre"
         # - EXTRASMODULES=
         - "BUILD_DEPENDENCIES=libmaxminddb-dev"
         # - RUN_DEPENDENCIES=

    # first run: mkdir conf && chmod 10000 conf
    # see readme.txt for rw permissions problems
    volumes:
       - ./inspircd-docker/conf/:/inspircd/conf/:rw

    # see .env
    environment:

      - INSP_NET_SUFFIX=.${HOST}
      - INSP_NET_NAME=${IRC}
      # autogenerated container id + insp_net_suffix
      - INSP_SERVER_NAME=

      - INSP_ADMIN_NAME=admin
      - INSP_ADMIN_NICK=admin
      - INSP_ADMIN_EMAIL=admin@example.com
      # - INSP_CONNECT_PASSWORD=changeme
      # - INSP_CONNECT_HASH=hmac-sha256

      # This should provide a basic protection for your server, but also causes problems  
      # if you want to use Tor or open proxies. Set INSP_ENABLE_DNSBL to no to disable them.
      - INSP_ENABLE_DNSBL=yes
  

      # /oper <nick> <passw>
      # /oper operator changeme
      - INSP_OPER_NAME=operator
      #  INS`_OPER_HOST=*@localhost, *@*
      - INSP_OPER_HOST=*@*
  
      # To generate a password hash connect to the network and
      # use /mkpasswd <hash-type> <password>
      # /mkpasswod sha256 changeme
      - INSP_OPER_HASH=sha256
      - INSP_OPER_PASSWORD=changeme
      - INSP_OPER_PASSWORD_HASH=057ba03d6c44104863dc7361fe4578965d1887360f90a0895882e58a6248fc86

      # - INSP_OPER_FINGERPRINT=
      - INSP_OPER_SSLONLY=no
      - INSP_OPER_AUTOLOGIN=no 


      # Currently we allow 3 links per container. 
      # Those link variables are INSP_LINK1_*, INSP_LINK2_*, and INSP_LINK3_*.
      # We only list the possible options once, but they work for INSP_LINK1_*, 
      # as well as for INSP_LINK2_* and INSP_LINK3_*.
      # - INSP_LINK1_NAME= 
      # - INSP_LINK1_IPADDR=
      # - INSP_LINK1_PORT=
      # - INSP_LINK1_SENDPASS=
      # - INSP_LINK1_RECVPASS=
      # - INSP_LINK1_PASSWORD=
      # - INSP_LINK1_ALLOWMASK=
      # - INSP_LINK1_TLS_ON=
      # - INSP_LINK1_FINGERPRINT=
      # - INSP_LINK1_OPTIONS=
      # - INSP_LINK1_AUTOCONNECT=



      - INSP_SERVICES_NAME=${SERVICES}
      - INSP_SERVICES_IPADDR=services

      # Make sure you run the services and InspIRCd container on the same docker network 
      # or specify the correct INSP_SERVICES_ALLOWMASK
      # - INSP_SERVICES_ALLOMASK=172.0.0.0/24
      
      - INSP_SERVICES_HIDDEN=no
      - INSP_SERVICES_SENDPASS=${SERVICES_PASSWORD}
      - INSP_SERVICES_RECVPASS=${SERVICES_PASSWORD}
      - INSP_SERVICES_PASSWORD=${SERVICES_PASSWORD}
      - INSP_SERVICES_TLS_ON=no
      - INSP_SERVICES_OPTIONS=
 
    ports:
      # plaintext
      - 6667:6667
      - 7000:7000
      # ssl
      - 6697:6697
      - 7001:7001

  services:
    image: anope/anope:testing
    restart: always

    build: anope-docker/. 

    volumes:
      - ./anope-docker/conf/:/anope/conf/

    environment:
      - ANOPE_SERVICES_NAME=${SERVICES}
      - ANOPE_UPLINK_IP=ircd
      - ANOPE_SERVICES_VHOST=${SERVICES}
      - ANOPE_UPLINK_PASSWORD=${SERVICES_PASSWORD}
      - ANOPE_UPLINK_PORT=${SERVICES_PORT}

      - ANOPE_SQL_ENGINE=${MYSQL_ENGINE}
      - ANOPE_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ANOPE_MYSQL_DB=${MYSQL_DATABASE}
      - ANOPE_MYSQL_HOST=database
      - ANOPE_MYSQL_PORT=${MYSQL_PORT}
      - ANOPE_MYSQL_USER=${MYSQL_USER}
      - ANOPE_SQL_LIVE=no

    depends_on:
      - ircd
      - database


  database:
    restart: always
    image: mariadb:latest

    volumes:
      - ./db:/var/lib/mysql

    environment:
      - MYSQL_MYSQL_HOST=database
      # - MYSQL_USER=anope
      # - MYSQL_PASSWORD=anope
      # - MYSQL_DATABASE=anope      
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_ROOT_PASSWORD=
